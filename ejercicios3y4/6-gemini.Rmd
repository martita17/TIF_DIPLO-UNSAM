---
title: "TRABAJO FINAL INTEGRADOR"
subtitle: "Modelos predictivos - Gemini"
author: "Fauquié - Peiretti - Tapia Serrano"
date: "`r Sys.Date()`"
output: 
  html_document: 
    theme: united
    fig_width: 10
    fig_height: 6
---

Consigna 4: Diseñar un prompt para que Gemini (el LLM que usamos en clase) para realizar la tarea del punto anterior. Extraer una muestra de unos 800 articulos usados en el punto anterior y clasificarlos mediante Gemini. Comparar los resultados de ambos modelos. ¿Cuál funciona mejor? Generar las métricas y visualizaciones para comparar ambos modelos. ¿Cuáles podrían ser las causas de ambos comportamientos?

```{r}
library(gemini.R)
```
Acá se le pone la api key
```{r}
api<-""
setAPI(api)
```
Prompt 1 (modo zero shot prompting, no se le da ningún ejemplo de las categorias)
```{r}
prompt1 <- "A continuación vas a recibir un texto de una nota periodística.
  Quisiera que la clasifiques como conservadora, progresista o neutra usando las siguientes categorías:

-conservador: la nota indica una postura conservadora
-progresista: la nota indica una postura progresista
-neutro: la nota no da señales de ninguna postura. 

No justifiques tu respuesta, ni des información adicional, sólo contesta con una de estas tres categorias: conservador, progresista y neutro

Este es el texto:"

```


Prompt 2 (modo few shot prompting, se le da un ejemplo de cada categoria). Para eso, primer se extraen ejemplos
```{r}
unique(bmodelo_filt$orientacion)

conservadores <- bmodelo_filt %>% 
  filter(orientacion == "+ conservador")
ej_conservador <- conservadores$texto[2]


progresistas <- bmodelo_filt %>% 
  filter(orientacion == "+ progresista")
ej_progresista <- progresistas$texto[2]


neutros <- bmodelo_filt %>% 
  filter(orientacion == "neutro")
ej_neutro <- neutros$texto[2] 


prompt2 <- paste(
  "A continuación vas a recibir un texto de una nota periodística.",
  "Quisiera que la clasifiques como conservadora, progresista o neutra usando las siguientes categorías:",
  "",
  "- conservador",
  "- progresista",
  "- neutro",
  "",
  "Este es un ejemplo conservador:", ej_conservador, 
  "Este es un ejemplo progresista:", ej_progresista, 
  "Este es un ejemplo neutro:", ej_neutro, 
  "",
  "Quisiera que expliques paso a paso tu razonamiento.",
  "",
  "La salida debería tener el siguiente formato:",
  "",
  "clasif: seguido de la clasificación",
  "expl: seguido de la explicación",
  "",
  "Este es el texto:"
)

prompt2

```

En caso de que en el prompt se pida explicación, se necesitan funciones para poder extraerlas, son estas:

```{r}
parse_clasif <- function(string){
        clasif <- str_extract(string, "(?<=clasif: )\\S+")
        return(clasif)
}

parse_expl <- function(string){
        expl <- str_trim(str_replace_all(str_extract(string, "(?<=expl).*"), ":|'", ""))
        return(expl)
}
```


Se le agrega a la base una columna pred que alojará las predicciones de gemini
```{r}
base_gem <- bmodelo_filt %>% 
  slice_sample(n = 800) %>% 
  mutate(pred = NA)


```

A continuación se hacen llamadas iterativas a gemini. Se puede usar "prompt1" (zero shot) o "prompt2" (few shot) según lo que se quiera probar
```{r}

for (i in 1:nrow(base_gem)){
                cat("Procesando noticia", i, "de", nrow(base_gem), "\n")
                rta <- gemini(paste0(prompt2, base_gem$texto[i]))
                base_gem$pred[i]=rta
                Sys.sleep(4.5)
                }


```
En caso de que el prompt suponga explicación, se hacen los procesamiento necesarios para extraer tanto la clasificación como la explicación

```{r}
base_gem_sep <- base_gem %>% 
  mutate(expl = parse_expl(pred),
        clasif = parse_clasif(pred))
  

```

Chequeo valores de clasif
```{r}
unique(base_gem_sep$clasif)
```


Normalizo y factorizo valores de orientacion y prediccion para poder compararlos 
```{r}
base_gem_reg <- base_gem_sep %>%
  mutate(orientacion = case_when(
    orientacion == "+ conservador" ~ "conservador",
    orientacion == "+ progresista" ~ "progresista",
    orientacion == "neutro" ~ "neutro",
    TRUE ~ orientacion
  )) %>% 
   mutate(clasif = trimws(clasif)) %>%
    mutate(clasif = tolower(trimws(clasif))) %>%
   mutate(clasif = case_when(clasif == "conservadora" ~ "conservador", TRUE ~ clasif))%>%
  mutate(orientacion=as.factor(orientacion)) %>%
  mutate(clasif=as.factor(clasif)) %>% 
  glimpse()
  
  
  
```
Ultimo chequeo de compatibilidad de los valores
```{r}
unique(base_gem_reg$clasif)
unique(base_gem_reg$orientacion)
```



Métricas de performance de gemini. Se guardan en una tabla gt que se exporta como imágen para poder pegarla en el informe
```{r}
library(gt)
metrics1_gem<-accuracy(base_gem_reg,orientacion,clasif) %>%
bind_rows(precision(base_gem_reg,orientacion,clasif)) %>%
bind_rows(recall(base_gem_reg,orientacion,clasif)) %>%
bind_rows(f_meas(base_gem_reg,orientacion,clasif)) %>% 
  select(-.estimator) %>% 
  gt() %>% 
  tab_header(
    title = md("Métricas de performance"),  
    subtitle = paste("Few shot con LLM"))%>%
  cols_label(
    .metric = md("**Metrica**"),   
    .estimate = md("**Estimado**") 
  ) %>%
  fmt_number(columns = vars(.estimate), decimals = 3) 

gtsave(metrics1_gem, "tabla_gemini_prompt2.png")
```
Matriz de confusión.
```{r}
library(yardstick)
library(gt)

metrics2_gem <- conf_mat(base_gem_reg, orientacion, clasif)
  
conf_matrix_table <- metrics2_gem$table
conf_matrix_df <- as.data.frame(conf_matrix_table) %>% 
  pivot_wider(names_from=Truth,values_from = Freq)
  
  
```
Se guardan en una tabla gt que se exporta como imágen para poder pegarla en el informe

```{r}
gt_table <- conf_matrix_df %>%
  gt() %>%
  tab_header(
    title = "Matriz de confusión",
    subtitle = "few shot con llm"
  ) %>%
  cols_label(
    Prediction = "Prediction"
  ) %>%
  fmt_number(columns = everything(), decimals = 0) %>%  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(80),  
    table.align = "center"
  )


for (i in 1:nrow(conf_matrix_df)) {
  for (col in colnames(conf_matrix_df)[-1]) {  # Skip the first column (Prediction)
    gt_table <- gt_table %>%
      tab_style(
        style = cell_fill(color = ifelse(conf_matrix_df$Prediction[i] == col, "lightgreen", "lightcoral")),
        locations = cells_body(rows = i, columns = col)
      )
  }
}
gtsave(gt_table, "matconf_gemini_prompt2.png")
gt_table


```